<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Tracker Pro</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --primary: #38bdf8;
            --income: #4ade80;
            --expense: #fb7185;
            --border: #334155;
            --accent: #f59e0b;
        }

        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; padding-bottom: 90px; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Navigation Bar */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; padding: 8px 0; 
            border-top: 1px solid var(--border); z-index: 1000; 
        }
        .nav-item { 
            background: none; border: none; color: var(--text-muted); 
            cursor: pointer; display: flex; flex-direction: column; 
            align-items: center; font-size: 0.65rem; font-weight: 700; 
            transition: 0.2s; width: 100px;
        }
        .nav-item.active { color: var(--primary); }
        .nav-icon { width: 22px; height: 22px; margin-bottom: 3px; fill: currentColor; }

        /* Header & Profile */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; position: relative; }
        .header h1 { color: var(--primary); margin: 0; }
        
        .profile-avatar { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid var(--border); }
        .profile-dropdown { 
            position: absolute; right: 0; top: 50px; background: var(--card); 
            border: 1px solid var(--border); border-radius: 12px; padding: 15px; 
            display: none; z-index: 2000; min-width: 180px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .profile-dropdown.active { display: block; }
        .logout-btn { background: var(--expense); color: white; border: none; padding: 8px; border-radius: 6px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 10px; }

        /* Auth Screen */
        #screen-auth { text-align: center; padding-top: 100px; }
        .google-btn { background: white; color: black; border: none; padding: 12px 24px; border-radius: 30px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; font-size: 1rem; }

        /* UI Elements */
        .backup-status { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border); background: #0f172a; color: var(--text-muted); margin-top: 5px; display: inline-block; }
        input, select { background: #0f172a; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; font-size: 0.95rem; width: 100%; box-sizing: border-box; outline: none; }
        
        input[type="date"], input[type="month"] {
            position: relative;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23ffffff' stroke-width='2.5'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 12px center; background-size: 15px;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid var(--border); }
        .stat-label { color: var(--accent); font-size: 0.85rem; font-weight: 700; text-transform: uppercase; }
        .stat-value { font-size: 1.75rem; font-weight: 800; margin-top: 8px; }

        .input-section { background: var(--card); padding: 25px; border-radius: 16px; margin-bottom: 30px; border: 1px solid var(--border); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; align-items: end; }
        .input-group label { color: var(--text-muted); font-weight: 600; font-size: 0.85rem; margin-bottom: 8px; text-transform: uppercase; display: block; }
        button.add-btn { background: var(--income); color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; height: 48px; width: 100%; }

        .dashboard-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 25px; }
        @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } }
        .panel { background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: var(--accent); font-size: 0.8rem; padding-bottom: 15px; text-transform: uppercase; }
        td { padding: 15px 5px; border-top: 1px solid var(--border); font-size: 0.95rem; }
        .btn-delete { color: var(--expense); background: none; border: 1px solid var(--expense); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: bold; }

        .list-item { background: #1e293b; padding: 18px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .list-item:hover { border-color: var(--primary); }
        .rank-badge { background: var(--primary); color: #000; padding: 2px 10px; border-radius: 6px; margin-right: 10px; font-size: 0.8rem; font-weight: bold; }
        .val-income { color: var(--income); font-weight: bold; }
        .val-expense { color: var(--expense); font-weight: bold; }
        .back-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 8px 15px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; }
        .search-container { margin-bottom: 15px; position: relative; }
        .search-input { padding-left: 35px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: 10px center; background-size: 18px; }
        .btn-outline { background: none; border: 1px solid var(--border); color: var(--text-muted); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-auth" class="screen active">
        <h1 style="color: var(--primary)">Finance Tracker Pro</h1>
        <p style="color: var(--text-muted); margin-bottom: 30px;">Sync your data across devices securely</p>
        <button class="google-btn" onclick="login()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="20"> 
            Sign in with Google
        </button>
    </div>

    <div id="main-app" style="display:none">
        <div class="header">
            <div>
                <h1>Finance Tracker</h1>
                <div id="backup-reminder" class="backup-status">Cloud Synced</div>
            </div>
            <div style="position: relative;">
                <img id="user-photo" class="profile-avatar" src="" onclick="toggleProfile()">
                <div id="profile-menu" class="profile-dropdown">
                    <div id="user-name" style="font-weight: bold; font-size: 0.9rem;"></div>
                    <div id="user-email" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;"></div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <div id="screen-home" class="screen">
            <div style="display:flex; justify-content:flex-end; margin-bottom: 20px;">
                <div style="width: auto;"><label style="font-size:0.7rem;">VIEW MONTH</label><input type="month" id="view-month" onchange="renderHome()"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">Monthly Earned</div><div id="m-earned" class="stat-value val-income">₹0.00</div></div>
                <div class="stat-card"><div class="stat-label">Monthly Spent</div><div id="m-spent" class="stat-value val-expense">₹0.00</div></div>
                <div class="stat-card"><div class="stat-label">Monthly Net</div><div id="m-net" class="stat-value">₹0.00</div></div>
            </div>

            <div class="input-section">
                <form id="finance-form" class="form-row">
                    <div class="input-group"><label>Date</label><input type="date" id="f-date" required></div>
                    <div class="input-group"><label>Description</label><input type="text" id="f-desc" placeholder="Rent, Salary..." required></div>
                    <div class="input-group"><label>Amount (₹)</label><input type="number" step="0.01" id="f-amount" required></div>
                    <div class="input-group"><label>Type</label><select id="f-type"><option value="expense">Expense (-)</option><option value="income">Income (+)</option></select></div>
                    <button type="submit" class="add-btn">Save Entry</button>
                </form>
            </div>

            <div class="dashboard-grid">
                <div class="panel">
                    <h3>Transaction History</h3>
                    <div class="search-container"><input type="text" id="search-bar" class="search-input" placeholder="Search..." oninput="renderHome()"></div>
                    <table><thead><tr><th>Date</th><th>Item</th><th>Amount</th><th>Action</th></tr></thead><tbody id="tx-list"></tbody></table>
                    <div style="margin-top: 20px; display:flex; gap:10px;">
                        <button class="btn-outline" onclick="exportCSV()">Export (.csv)</button>
                        <button class="btn-outline" onclick="document.getElementById('import-file').click()">Import</button>
                        <input type="file" id="import-file" style="display:none" accept=".csv" onchange="importCSV(this)">
                    </div>
                </div>
                <div class="panel"><h3>Daily Spending Rank</h3><div id="rank-list"></div></div>
            </div>
        </div>

        <div id="screen-analysis" class="screen"><div id="analysis-content"></div></div>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('home', this)"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>HOME</span></button>
            <button class="nav-item" onclick="switchTab('analysis', this)"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>ANALYSIS</span></button>
        </nav>
    </div>
</div>

<script>
    // 1. CONFIG (Paste your specific credentials here)
const firebaseConfig = {
  apiKey: "AIzaSyDVKDiOnC1Wqvbg7-vymDW5hdo5hmdZ5nI",
  authDomain: "finance-tracker-0710.firebaseapp.com",
  projectId: "finance-tracker-0710",
  storageBucket: "finance-tracker-0710.firebasestorage.app",
  messagingSenderId: "844155637274",
  appId: "1:844155637274:web:125b220fa0ce26650c0ba3",
  measurementId: "G-ERJEFPQ4B3"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let entries = [];

    // --- AUTH LOGIC ---
    async function login() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try { await auth.signInWithPopup(provider); } catch (e) { alert(e.message); }
    }
    function logout() { auth.signOut(); }
    function toggleProfile() { document.getElementById('profile-menu').classList.toggle('active'); }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('screen-auth').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('user-photo').src = user.photoURL || '';
            document.getElementById('user-name').innerText = user.displayName;
            document.getElementById('user-email').innerText = user.email;
            switchTab('home', document.querySelector('.nav-item'));
            startSync(user.uid);
        } else {
            document.getElementById('screen-auth').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
        }
    });

    // --- DATA LOGIC ---
    function startSync(uid) {
        // Fetch data for specific user only
        db.collection("finance_data").where("uid", "==", uid).onSnapshot(snap => {
            entries = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderHome();
        });
    }

    document.getElementById('finance-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = auth.currentUser;
        const newEntry = {
            uid: user.uid,
            timestamp: Date.now(), // Used for internal chronological sorting
            date: document.getElementById('f-date').value,
            desc: document.getElementById('f-desc').value,
            amount: parseFloat(document.getElementById('f-amount').value),
            type: document.getElementById('f-type').value
        };
        await db.collection("finance_data").add(newEntry);
        e.target.reset();
        document.getElementById('f-date').valueAsDate = new Date();
    });

    async function deleteEntry(id) { if(confirm("Delete this entry?")) await db.collection("finance_data").doc(id).delete(); }

    // --- UI RENDERING ---
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    document.getElementById('view-month').value = new Date().toISOString().slice(0, 7);
    document.getElementById('f-date').valueAsDate = new Date();

    function formatINR(amt) { return '₹' + parseFloat(amt).toLocaleString('en-IN', { minimumFractionDigits: 2 }); }
    function prettyDate(d) { const [y, m, day] = d.split('-'); return `${day}-${m}-${y}`; }

    function switchTab(id, btn) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(`screen-${id}`).classList.add('active');
        btn.classList.add('active');
        if(id === 'analysis') renderMonthlyAnalysis();
    }

    function renderHome() {
        const selMonth = document.getElementById('view-month').value;
        const query = document.getElementById('search-bar').value.toLowerCase();
        const txList = document.getElementById('tx-list');
        const rankList = document.getElementById('rank-list');
        txList.innerHTML = ''; rankList.innerHTML = '';

        const monthData = entries.filter(e => e.date.startsWith(selMonth));
        
        // Latest entry at the top: Sort by Date descending, then by Timestamp descending
        const filtered = monthData.filter(e => e.desc.toLowerCase().includes(query))
                                  .sort((a,b) => (b.date + b.timestamp).localeCompare(a.date + a.timestamp));

        let tIn = 0, tOut = 0, dailyMap = {};
        monthData.forEach(e => {
            if(e.type === 'income') tIn += e.amount;
            else { tOut += e.amount; dailyMap[e.date] = (dailyMap[e.date] || 0) + e.amount; }
        });

        filtered.forEach(e => {
            txList.insertAdjacentHTML('beforeend', `<tr><td style="color:var(--text-muted)">${prettyDate(e.date)}</td><td>${e.desc}</td><td class="val-${e.type}">${e.type==='income'?'+':'-'}${formatINR(e.amount)}</td><td><button class="btn-delete" onclick="deleteEntry('${e.id}')">Delete</button></td></tr>`);
        });

        document.getElementById('m-earned').innerText = formatINR(tIn);
        document.getElementById('m-spent').innerText = formatINR(tOut);
        const net = tIn - tOut;
        const netEl = document.getElementById('m-net');
        netEl.innerText = formatINR(net);
        netEl.className = 'stat-value ' + (net >= 0 ? 'val-income' : 'val-expense');

        // Rank list (High spenders)
        const rankedDays = Object.keys(dailyMap).map(d => ({ date: d, total: dailyMap[d] })).sort((a,b) => b.total - a.total);
        rankedDays.forEach((day, i) => {
            rankList.insertAdjacentHTML('beforeend', `<div class="list-item" style="padding:10px;margin-bottom:8px;"><span><span class="rank-badge">#${i+1}</span> ${prettyDate(day.date)}</span><span class="val-expense">${formatINR(day.total)}</span></div>`);
        });
    }

    // --- ANALYSIS DRILL DOWN ---
    function renderMonthlyAnalysis() {
        const content = document.getElementById('analysis-content');
        content.innerHTML = '<h1>Spend Analysis</h1>';
        let months = {};
        entries.forEach(e => { if(e.type === 'expense') { const m = e.date.substring(0,7); months[m] = (months[m] || 0) + e.amount; } });
        
        // Chronological: Jan at top, Dec at bottom
        Object.keys(months).sort().forEach(m => {
            const [y, mo] = m.split('-');
            content.insertAdjacentHTML('beforeend', `<div class="list-item" onclick="renderDailyAnalysis('${m}')"><div><span style="font-weight:700">${monthNames[parseInt(mo)-1]} ${y}</span></div><span class="val-expense">${formatINR(months[m])}</span></div>`);
        });
    }

    function renderDailyAnalysis(mKey) {
        const content = document.getElementById('analysis-content');
        content.innerHTML = `<button class="back-btn" onclick="renderMonthlyAnalysis()">⬅ Back</button><h1>Daily Breakdown</h1>`;
        let days = {};
        entries.filter(e => e.date.startsWith(mKey) && e.type === 'expense').forEach(e => { days[e.date] = (days[e.date] || 0) + e.amount; });
        
        // Chronological: 1st at top, 31st at bottom
        Object.keys(days).sort().forEach(d => {
            content.insertAdjacentHTML('beforeend', `<div class="list-item" onclick="renderItemDetails('${d}')"><span>${prettyDate(d)}</span><span class="val-expense">${formatINR(days[d])}</span></div>`);
        });
    }

    function renderItemDetails(date) {
        const content = document.getElementById('analysis-content');
        content.innerHTML = `<button class="back-btn" onclick="renderDailyAnalysis('${date.substring(0,7)}')">⬅ Back</button><h1>Items</h1>`;
        
        // Oldest item first for that day: Sort by Timestamp ascending
        entries.filter(e => e.date === date && e.type === 'expense').sort((a,b) => a.timestamp - b.timestamp).forEach(e => {
            content.insertAdjacentHTML('beforeend', `<div class="list-item" style="cursor:default"><span>${e.desc}</span><span class="val-expense">${formatINR(e.amount)}</span></div>`);
        });
    }

    // --- UTILITIES ---
    function exportCSV() {
        let csv = "Date,Description,Amount,Type\n";
        entries.forEach(e => { csv += `${e.date},${e.desc},${e.amount},${e.type}\n`; });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = window.URL.createObjectURL(blob);
        a.download = `finance_backup.csv`;
        a.click();
    }

    function importCSV(input) {
        const reader = new FileReader();
        reader.onload = async function() {
            const rows = reader.result.split('\n').slice(1);
            const user = auth.currentUser;
            for(let row of rows) {
                if(row.trim()) {
                    const [date, desc, amount, type] = row.split(',');
                    await db.collection("finance_data").add({ uid: user.uid, timestamp: Date.now(), date, desc, amount: parseFloat(amount), type: type.trim() });
                }
            }
            alert("Import complete!");
        };
        reader.readAsText(input.files[0]);
    }
</script>
</body>
</html>
